const Ultraviolet=self.Ultraviolet,cspHeaders=["cross-origin-embedder-policy","cross-origin-opener-policy","cross-origin-resource-policy","content-security-policy","content-security-policy-report-only","expect-ct","feature-policy","origin-isolation","strict-transport-security","upgrade-insecure-requests","x-content-type-options","x-download-options","x-frame-options","x-permitted-cross-domain-policies","x-powered-by","x-xss-protection"],emptyMethods=["GET","HEAD"];class UVServiceWorker extends Ultraviolet.EventEmitter{constructor(e){e||(e=__uv$config),e.encodeUrl=__uv$config.encodeUrl,e.decodeUrl=__uv$config.decodeUrl,super(),e.bare||(e.bare="/bare/"),e.prefix||(e.prefix="/service/"),this.config=e;const t=(Array.isArray(e.bare)?e.bare:[e.bare]).map((e=>new URL(e,location).toString()));this.address=t[~~(Math.random()*t.length)],this.bareClient=new Ultraviolet.BareClient(this.address)}async fetch({request:e}){let t;try{if(!e.url.startsWith(location.origin+this.config.prefix))return await fetch(e);const r=new Ultraviolet(this.config,this.address);"function"==typeof this.config.construct&&this.config.construct(r,"service");const i=await r.cookie.db();r.meta.origin=location.origin,r.meta.base=r.meta.url=new URL(r.sourceUrl(e.url));const o=new RequestContext(e,this,r,emptyMethods.includes(e.method.toUpperCase())?null:await e.blob());if("blob:"===r.meta.url.protocol&&(o.blob=!0,o.base=o.url=new URL(o.url.pathname)),e.referrer&&e.referrer.startsWith(location.origin)){const t=new URL(r.sourceUrl(e.referrer));(o.headers.origin||r.meta.url.origin!==t.origin&&"cors"===e.mode)&&(o.headers.origin=t.origin),o.headers.referer=t.href}const s=await r.cookie.getCookies(i)||[],n=r.cookie.serialize(s,r.meta,!1);o.headers["user-agent"]=navigator.userAgent,n&&(o.headers.cookie=n);const a=new HookEvent(o,null,null);if(this.emit("request",a),a.intercepted)return a.returnValue;t=o.blob?"blob:"+location.origin+o.url.pathname:o.url;const l=await this.bareClient.fetch(t,{headers:o.headers,method:o.method,body:o.body,credentials:o.credentials,mode:location.origin!==o.address.origin?"cors":o.mode,cache:o.cache,redirect:o.redirect,proxyIp:this.config.proxyIp,proxyPort:this.config.proxyPort}),c=new ResponseContext(o,l),d=new HookEvent(c,null,null);if(this.emit("beforemod",d),d.intercepted)return d.returnValue;for(const e of cspHeaders)c.headers[e]&&delete c.headers[e];if(c.headers.location&&(c.headers.location=r.rewriteUrl(c.headers.location)),"document"===e.destination){const e=c.headers["content-disposition"];if(!/\s*?((inline|attachment);\s*?)filename=/i.test(e)){const t=/^\s*?attachment/i.test(e)?"attachment":"inline",[r]=new URL(l.finalURL).pathname.split("/").slice(-1);c.headers["content-disposition"]=`${t}; filename=${JSON.stringify(r)}`}}if(c.headers["set-cookie"]&&(Promise.resolve(r.cookie.setCookies(c.headers["set-cookie"],i,r.meta)).then((()=>{self.clients.matchAll().then((function(e){e.forEach((function(e){e.postMessage({msg:"updateCookies",url:r.meta.url.href})}))}))})),delete c.headers["set-cookie"]),c.body)switch(e.destination){case"script":case"worker":{const t=[r.bundleScript,r.clientScript,r.configScript,r.handlerScript].map((e=>JSON.stringify(e))).join(",");c.body=`if (!self.__uv && self.importScripts) { ${r.createJsInject(this.address,this.bareClient.manfiest,r.cookie.serialize(s,r.meta,!0),e.referrer)} importScripts(${t}); }\n`,c.body+=r.js.rewrite(await l.text())}break;case"style":c.body=r.rewriteCSS(await l.text());break;case"iframe":case"document":isHtml(r.meta.url,c.headers["content-type"]||"")&&(c.body=r.rewriteHtml(await l.text(),{document:!0,injectHead:r.createHtmlInject(r.handlerScript,r.bundleScript,r.clientScript,r.configScript,this.address,this.bareClient.manfiest,r.cookie.serialize(s,r.meta,!0),e.referrer)}))}return"text/event-stream"===o.headers.accept&&(c.headers["content-type"]="text/event-stream"),crossOriginIsolated&&(c.headers["Cross-Origin-Embedder-Policy"]="require-corp"),this.emit("response",d),d.intercepted?d.returnValue:new Response(c.body,{headers:c.headers,status:c.status,statusText:c.statusText})}catch(r){return["document","iframe"].includes(e.destination)?(console.error(r),renderError(r,t,this.address)):new Response(void 0,{status:500})}}static Ultraviolet=Ultraviolet}self.UVServiceWorker=UVServiceWorker;class ResponseContext{constructor(e,t){this.request=e,this.raw=t,this.ultraviolet=e.ultraviolet,this.headers={};for(const e in t.rawHeaders)this.headers[e.toLowerCase()]=t.rawHeaders[e];this.status=t.status,this.statusText=t.statusText,this.body=t.body}get url(){return this.request.url}get base(){return this.request.base}set base(e){this.request.base=e}}class RequestContext{constructor(e,t,r,i=null){this.ultraviolet=r,this.request=e,this.headers=Object.fromEntries(e.headers.entries()),this.method=e.method,this.address=t.address,this.body=i||null,this.cache=e.cache,this.redirect=e.redirect,this.credentials="omit",this.mode="cors"===e.mode?e.mode:"same-origin",this.blob=!1}get url(){return this.ultraviolet.meta.url}set url(e){this.ultraviolet.meta.url=e}get base(){return this.ultraviolet.meta.base}set base(e){this.ultraviolet.meta.base=e}}function isHtml(e,t=""){return"text/html"===(Ultraviolet.mime.contentType(t||e.pathname)||"text/html").split(";")[0]}class HookEvent{#e;#t;constructor(e={},t=null,r=null){this.#e=!1,this.#t=null,this.data=e,this.target=t,this.that=r}get intercepted(){return this.#e}get returnValue(){return this.#t}respondWith(e){this.#t=e,this.#e=!0}}function hostnameErrorTemplate(e,t){const r=new URL(e),i=`remoteHostname.textContent = ${JSON.stringify(r.hostname)};bareServer.href = ${JSON.stringify(t)};uvHostname.textContent = ${JSON.stringify(location.hostname)};reload.addEventListener("click", () => location.reload());uvVersion.textContent = ${JSON.stringify(process.env.ULTRAVIOLET_VERSION)};`;return`<!DOCTYPE html><html><head><meta charset='utf-8' /><title>Error</title></head><body><h1>This site can’t be reached</h1><hr /><p><b id="remoteHostname"></b>’s server IP address could not be found.</p><p>Try:</p><ul><li>Verifying you entered the correct address</li><li>Clearing the site data</li><li>Contacting <b id="uvHostname"></b>'s administrator</li><li>Verifying the <a id='bareServer' title='Bare server'>Bare server</a> isn't censored</li></ul><button id="reload">Reload</button><hr /><p><i>Ultraviolet v<span id="uvVersion"></span></i></p><script src="${"data:application/javascript,"+encodeURIComponent(i)}"><\/script></body></html>`}function errorTemplate(e,t,r,i,o,s,n){if("The specified host could not be resolved."===i)return hostnameErrorTemplate(s,n);const a=`errorTitle.textContent = ${JSON.stringify(e)};errorCode.textContent = ${JSON.stringify(t)};`+(r?`errorId.textContent = ${JSON.stringify(r)};`:"")+`errorMessage.textContent =  ${JSON.stringify(i)};`+`errorTrace.value = ${JSON.stringify(o)};`+`fetchedURL.textContent = ${JSON.stringify(s)};`+`bareServer.href = ${JSON.stringify(n)};`+`for (const node of document.querySelectorAll("#uvHostname")) node.textContent = ${JSON.stringify(location.hostname)};reload.addEventListener("click", () => location.reload());`+`uvVersion.textContent = ${JSON.stringify(process.env.ULTRAVIOLET_VERSION)};`;return'<!DOCTYPE html><html><head><meta charset=\'utf-8\' /><title>Error</title></head><body><h1 id=\'errorTitle\'></h1><hr /><p>Failed to load <b id="fetchedURL"></b></p><p id="errorMessage"></p><table><tbody><tr><td>Code:</td><td id="errorCode"></td></tr>'+(r?'<tr><td>ID:</td><td id="errorId"></td></tr>':"")+'</tbody></table><textarea id="errorTrace" cols="40" rows="10" readonly></textarea><p>Try:</p><ul><li>Checking your internet connection</li><li>Verifying you entered the correct address</li><li>Clearing the site data</li><li>Contacting <b id="uvHostname"></b>\'s administrator</li><li>Verify the <a id=\'bareServer\' title=\'Bare server\'>Bare server</a> isn\'t censored</li></ul><p>If you\'re the administrator of <b id="uvHostname"></b>, try:</p><ul><li>Restarting your Bare server</li><li>Updating Ultraviolet</li><li>Troubleshooting the error on the <a href="https://github.com/titaniumnetwork-dev/Ultraviolet" target="_blank">GitHub repository</a></li></ul><button id="reload">Reload</button><hr /><p><i>Ultraviolet v<span id="uvVersion"></span></i></p>'+`<script src="${"data:application/javascript,"+encodeURIComponent(a)}"><\/script></body></html>`}function isBareError(e){return e instanceof Error&&"object"==typeof e.body}function renderError(e,t,r){let i,o,s,n,a="";return isBareError(e)?(i=e.status,o="Error communicating with the Bare server",n=e.body.message,s=e.body.code,a=e.body.id):(i=500,o="Error processing your request",n="Internal Server Error",s=e instanceof Error?e.name:"UNKNOWN"),new Response(errorTemplate(o,s,a,n,String(e),t,r),{status:i,headers:{"content-type":"text/html"}})}
